{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row g-4 justify-content-center">

        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Classify by URL</h2>
                    <form action="{{ url_for('classify') }}" method="POST">
                        <div class="mb-3">
                            <label for="image_url" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="image_url" name="image_url" placeholder="https://example.com/image.jpg" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" name="action" value="single" class="btn btn-primary">Classify URL</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Classify Multiple URLs</h2>
                    <form action="{{ url_for('classify') }}" method="POST">
                        <div class="mb-3">
                            <label for="image_urls" class="form-label">Image URLs (one per line)</label>
                            <textarea class="form-control" id="image_urls" name="image_urls" rows="5" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png" required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" name="action" value="batch" class="btn btn-secondary">Classify All URLs</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Classify by Upload or Paste</h2>
                    <form id="file-upload-form" action="{{ url_for('classify') }}" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="action" value="file">
                        
                        <div id="paste-box" class="text-center p-3 mb-3" style="border: 2px dashed #0d6efd; border-radius: .375rem; cursor: pointer; background-color: #f8f9fa;">
                            <p class="text-muted m-0 small">Click and press Ctrl+V to paste</p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="image_file" class="form-label">Or select a file:</label>
                            <input class="form-control" type="file" id="image_file" name="image_file" accept="image/*">
                        </div>
                        
                        <div class="text-center mb-3" style="min-height: 100px;">
                            <img id="image-preview" src="" class="img-fluid rounded" alt="Image preview" style="max-height: 100px; display: none;">
                        </div>

                        <div class="d-grid">
                            <button type="submit" id="classify-file-btn" class="btn btn-success" disabled>Classify Image</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mt-5">
        <div class="col-md-10 col-lg-8">

            {% if single_error or batch_error or file_error %}
            <div class="alert alert-danger" role="alert">
                <strong>Error:</strong> {{ single_error or batch_error or file_error }}
            </div>
            {% endif %}

            {% if prediction and image_url %}
            <div class="card shadow-sm">
                <div class="card-header text-center fs-5">URL Classification Result</div>
                <div class="card-body text-center">
                    <img src="{{ image_url }}" class="img-fluid rounded mb-3" alt="Classified Image" style="max-height: 300px;">
                    <h3 class="card-title">Prediction: <span class="text-primary">{{ prediction }}</span></h3>
                    <h3 class="card-title">Confidence: <span class="text-primary">{{ confidence_level }}%</span></h3>
                </div>
            </div>
            {% endif %}

            {% if job_id %}
            <div class="card shadow-sm">
                <div class="card-header text-center fs-5">Batch Job Submitted</div>
                <div class="card-body text-center">
                    <h3 class="card-title">Job ID: <span class="text-primary">{{ job_id }}</span></h3>
                    <p>You can view the results on the "View Job" page.</p>
                </div>
            </div>
            {% endif %}

            {% if file_result %}
            <div class="card shadow-sm">
                <div class="card-header text-center fs-5">File Classification Result</div>
                <div class="card-body text-center">
                    <h3 class="card-title">File Name: <span class="text-success">{{ file_result.fileName }}</span></h3>
                    <h3 class="card-title">Prediction: <span class="text-primary">{{ file_result.predicted_class | replace("_", " ") | title }}</span></h3>
                    <h3 class="card-title">Confidence: <span class="text-primary">{{ file_result.confidence_level }}%</span></h3>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('image_file');
    const pasteBox = document.getElementById('paste-box');
    const preview = document.getElementById('image-preview');
    const classifyBtn = document.getElementById('classify-file-btn');

    const handleFile = (file) => {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            classifyBtn.disabled = false;
        } else {
            preview.src = '';
            preview.style.display = 'none';
            classifyBtn.disabled = true;
        }
    };
    
    fileInput.addEventListener('change', () => {
        handleFile(fileInput.files[0]);
    });

    pasteBox.addEventListener('paste', (event) => {
        const items = (event.clipboardData || window.clipboardData).items;
        let file = null;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                file = item.getAsFile();
                break;
            }
        }

        if (file) {
            // Create a new FileList object and assign it to the file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            // Manually trigger the 'change' event to update the UI
            handleFile(file);
        }
    });
});
</script>
{% endblock %}