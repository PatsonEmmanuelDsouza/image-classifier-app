{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-4">
        <h2>{{ title }}</h2>
        <p class="text-muted">Review the image classifications and take action.</p>
    </div>

    {% if error %}
    <div class="alert alert-danger text-center" role="alert">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if images %}
    <div id="image-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for image in images %}
        <div class="col">
            <div class="card h-100 shadow-sm review-card">
                <img src="{{ image.url }}" class="card-img-top" alt="Image to review" style="height: 200px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title">Prediction: <span class="text-primary">{{ image.predicted_class | replace("_", " ") | title }}</span></h5>
                    <p class="card-text mb-2">Confidence: <strong>{{ image.confidence_level }}%</strong></p>
                    <p class="card-text"><small class="text-muted">Status: {{ image.status }}</small></p>
                </div>
                <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                    <button class="btn btn-success btn-sm review-action-btn" 
                            data-action="review" 
                            data-url="{{ image.url }}">
                        Mark as Reviewed
                    </button>
                    <button class="btn btn-warning btn-sm review-action-btn" 
                            data-action="relabel" 
                            data-url="{{ image.url }}">
                        Relabel
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif not error %}
        <div class="alert alert-info text-center" role="alert">
            There are no images to review at this time.
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const actionButtons = document.querySelectorAll('.review-action-btn');

    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const imageUrl = this.dataset.url;
            const cardElement = this.closest('.review-card');

            const apiKey = '{{ api_key | safe }}';

            let targetApiUrl;
            
            if (action === 'review') {
                targetApiUrl = '{{ backend_set_reviewed_url }}';
            } else if (action === 'relabel') {
                targetApiUrl = '{{ backend_relabel_url }}';
            } else {
                return;
            }

            cardElement.querySelectorAll('button').forEach(btn => btn.disabled = true);

            fetch(targetApiUrl, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({ image_url: imageUrl }),
            })
            .then(response => {
                  if (!response.ok) {
                    // Check for specific API key error codes
                    if (response.status === 401 || response.status === 403) {
                        // Throw a specific error for auth issues
                        throw new Error('Invalid API Key. You need to use an admin API key to review images! Please re-enter a valid admin key in the navbar and try again.');
                    }
                    // For other errors, try to read the error message from the backend
                    return response.json().then(err => { 
                        throw new Error(err.detail || `HTTP error! Status: ${response.status}`);
                    });
                }
                return response.status === 204 ? null : response.json();
            })
            .then(data => {
                console.log('Success:', data || 'No content received (204)');
                cardElement.style.transition = 'opacity 0.5s ease';
                cardElement.style.opacity = '0';
                setTimeout(() => {
                    cardElement.parentElement.remove();
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`An error occurred while trying to ${action} the image \n${error}`);
                cardElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
            });
        });
    });
});
</script>

{% endblock %}